go with microservice
container, gateway, batch
4 Oct 2016
Tags: golang,docker,immutable infrastructure, infrastructure as a code

jun asano
http://ntk1000.github.io/zlog
@ntk1000

* about me

- intelligence seeds company
- father of 2 boyz (5æ­³ã¨1æ­³)

about seeds company

- hito-manager
- applicant tracking system
- b2c/b2b web service

* project

from 

    legacy monolithic rails app 

to 

    "microservice"s


* why "microservice"?

ğŸ˜­

- ä¸€éƒ¨ã®æ©Ÿèƒ½ã«ã¤ã„ã¦å…¨ä½“ãŒå½±éŸ¿ã‚’å—ã‘ã‚‹
- ç‰¹å®šé¡§å®¢å°‚ç”¨ã®æ©Ÿèƒ½ãŒç®¡ç†ä¸Šå…¨ä½“ã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹
- å¯†çµåˆã—ã¦ã—ã¾ã£ãŸcode

ğŸ˜Œ

- å½±éŸ¿å±€æ‰€åŒ–ã€å€‹åˆ¥deploy
- æ©Ÿèƒ½ã®ç‰¹æ€§ã«å¿œã˜ãŸæœ€é©ãªæŠ€è¡“ã®é©ç”¨
- æ©Ÿèƒ½åˆ¥ã«scale up/down

* how to develop microservices

- ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¯ã«serviceã¨ã—ã¦åˆ†å‰²(ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã€ç­‰)
- (é¡§å®¢æ•° x ãƒ¡ãƒ‹ãƒ¥ãƒ¼)æ•°ã¶ã‚“serviceãŒç«‹ã¡ä¸Šã’ã‚‹æ§‹æˆ
- containerğŸ³åŒ–ã—ã¦resourceç¯€ç´„

why golang?

- 1ã¤ã®binaryã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹portablity
- Dockerfileä¸Šã§ã¯buildã—ãŸbinaryã‚’ADDã™ã‚‹ã ã‘
- èµ·å‹•ã‚‚æ—©ãã€image sizeã‚‚å°ã•ãã€containerã¨ç›¸æ€§è‰¯ã„å®Ÿæ„ŸğŸ’œ
- (å€‹äººçš„ã«ã¯) teamé–‹ç™ºã®ã—ã‚„ã™ã•

* Dockerfile

    FROM gliderlabs/alpine:3.3
    RUN apk update

    ADD . /app
    WORKDIR /app

    CMD ["/app/appName"]

- base imageã¨ã—ã¦ã¯alpineã‚’æ¡ç”¨
- ADDã§test/buildå¾Œã®binaryã‚’containerã«æ¸¡ã—ã¦ã„ã‚‹
- CMDã§binaryã‚’å®Ÿè¡Œ

* service pattern

- å„æ©Ÿèƒ½ã¯serviceã¨ã—ã¦ç‹¬ç«‹ã•ã›ãŸã„
- æ©Ÿèƒ½ã‚’ä½¿ã†å´(ä¸»ã«WebUI)ã«ã¯å„serviceã®è©³ç´°ã¯æ„è­˜ã•ã›ãŸããªã„

backends for frontends (or api gateway)
.image ./img/bff.png 350 _

* framework

.link https://github.com/labstack/echo echo

why echo?

- é€Ÿã•ã¨è»½ã•
- go-kitãªã©microserviceå‘ã‘frameworkã‚‚æ¤œè¨ã—ãŸãŒã—ã£ãã‚Šã“ãªã‹ã£ãŸ

* api layer

- frontend 
ui / ui backend

- gateway
bff / apigateway

- backend
å„æ©Ÿèƒ½æ¯ã®API


* architecture

.image ./img/aws.png 580 1800


* architecture

- orchestration: aws ecs
- container registry: aws ecr
- service discovery: aws elb/alb
- container hostos: coreos

* gateway...

å¤±æ•—

- backend APIã§æ›´æ–°ãŒã‚ã‚‹åº¦ã«gatewayå®Ÿè£…ãŒå¿…è¦
- gatewayãŒfatä¸”ã¤SPOF
- é–‹ç™ºãŒé€²ã‚“ã§APIãŒå¢—ãˆã‚‹æ¯ã«é™¤ã€…ã«gatewayã®å­˜åœ¨ãŒè² æ‹…ã«...

ãã‚‚ãã‚‚

- APIã®è¿½åŠ ãƒ»æ›´æ–°ã¯pluggableã«è¡ŒãˆãŸã»ã†ãŒã‚ˆã•ãã†
- ã“ã®éƒ¨åˆ†ã¯buildå‰æãªgoã«å‘ã„ã¦ãªã„ï¼Ÿ

* api gateway oss

ä¸‹è¨˜ã®ã‚ˆã†ãªapi gateway toolã®å°å…¥ã‚’æ¤œè¨ä¸­

.link https://getkong.org/ kong
.image https://camo.githubusercontent.com/97aabdfeec1d04a818e3393c3bade3f54704852f/687474703a2f2f692e696d6775722e636f6d2f346a795151415a2e706e67 130 _

.link https://tyk.io/ tyk
.image https://tyk.io/wp-content/uploads/2016/03/TYK_FullLogo_WhiteText-1.png 150 _

* summary

- 
