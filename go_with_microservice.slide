go with microservice
with container, api gateway pattern
4 Oct 2016
Tags: golang,docker,microservice

jun asano
http://ntk1000.github.io/zlog
@ntk1000

* about me

- intelligence seeds company
- 5æ­³ã¨1æ­³ã®ãƒ ã‚¹ã‚³ãŒãŠã‚Šã€æ—¥ã€…è‚²å…ã«è¿½ã‚ã‚Œã¦ã„ã¾ã™

about seeds company

- product : hito-manager
- applicant tracking system
- b2c / b2b web service

* project

from 

    monolithic legacy rails app 

to 

    "microservice"s


* why "microservice"?

ğŸ˜­ è¾›ã¿

- å¯†çµåˆã—ã¦ã—ã¾ã£ãŸcode
- ä¸€éƒ¨ã®æ©Ÿèƒ½ã«ã¤ã„ã¦å…¨ä½“ãŒå½±éŸ¿ã‚’å—ã‘ã¦ã—ã¾ã†
- ç‰¹å®šé¡§å®¢å°‚ç”¨ã®æ©Ÿèƒ½ãŒç®¡ç†ä¸Šå…¨ä½“ã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹
- è² è·ã®é«˜ã„ãƒ»ä½ã„æ©Ÿèƒ½ãŒæ··åœ¨ã—ã¦ãŠã‚Šæœ€é©ãªscale up/downãŒã§ããªã„

ğŸ˜Œ è§£æ±ºï¼Ÿ

- serviceã¨ã„ã†å˜ä½ã§å½±éŸ¿ç¯„å›²ã‚’é™å®š
- æ©Ÿèƒ½ã®ç‰¹æ€§ã«å¿œã˜ãŸæœ€é©ãªæŠ€è¡“ã®é©ç”¨
- ç‰¹å®šé¡§å®¢å°‚ç”¨æ©Ÿèƒ½ã‚‚ä»˜åŠ serviceã¨ã„ã†å½¢ã§åˆ‡å‡ºã—å¯èƒ½
- æ©Ÿèƒ½ã®è² è·ã«å¿œã˜ã¦æ©Ÿèƒ½å˜ä½ã§scale up/downãŒå¯èƒ½

* how to develop microservices

- ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¯ã«serviceã¨ã—ã¦åˆ†å‰² (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã€ç­‰)
- (é¡§å®¢ x ãƒ¡ãƒ‹ãƒ¥ãƒ¼) æ•°ã¶ã‚“serviceãŒç«‹ã¡ä¸Šã’ã‚‹æ§‹æˆã‚’æƒ³å®š
- containerğŸ³åŒ–ã—ã¦resourceç¯€ç´„ ->dockerã®æ¡ç”¨

why golang?

- 1ã¤ã®binaryã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹portablity
- Dockerfileä¸Šã§ã¯buildã—ãŸbinaryã‚’ADDã™ã‚‹ã ã‘
- èµ·å‹•ã‚‚æ—©ãimage sizeã‚‚å°ã•ã„ãŸã‚ã€containerã¨è¦ªå’Œæ€§é«˜ã„
- (å€‹äººçš„ã«ã¯) teamé–‹ç™ºã®ã—ã‚„ã™ã•ã‚‚(fmt etc.)

* Dockerfile

    FROM gliderlabs/alpine:3.3
    RUN apk update

    ADD . /app
    WORKDIR /app

    CMD ["/app/appName"]

- base imageã¨ã—ã¦è»½é‡ãªalpineã‚’æ¡ç”¨
- test/buildå¾Œã®binaryã‚’ADDã§containerã«æ¸¡ã™ã ã‘

* API pattern

- ãƒ¡ãƒ‹ãƒ¥ãƒ¼(service)ã¯ç‹¬ç«‹ã—ãŸRESTful APIã¨ã—ã¦å‹•ä½œã•ã›ã‚‹
- ä¸€æ–¹ã§æ©Ÿèƒ½ã‚’ä½¿ã†client(ä¸»ã«WebUI)ã«ã¯å„serviceã®è©³ç´°ã¯æ„è­˜ã•ã›ãŸããªã„
- ã¤ã¾ã‚Šã€å„APIã¨clientã®é–“ã«facadeçš„ãªå½¹å‰²ã‚’ç½®ããŸã„

* backends for frontends (or api gateway)

.image ./img/bff.png 400 _
via ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ p.85  oreilly

* framework

.link https://github.com/labstack/echo echo
.image https://echo.labstack.com/images/logo.png

why echo?

- é€Ÿã•ã¨è»½ã•
- go-kitãªã©microserviceå‘ã‘frameworkã‚‚æ¤œè¨ã—ãŸãŒã—ã£ãã‚Šã“ãªã‹ã£ãŸ

* api layer

- 1st layer -> ui / ui backend ã¨ã—ã¦ã®frontendå±¤
- 2nd layer -> bff / api gateway ã¨ã—ã¦ã®gatewayå±¤
- 3rd layer -> å„service APIã‚’é…ç½®ã™ã‚‹backendå±¤

* architecture overview
.image ./img/aws.png 580 _

* architecture

- container orchestration: aws ecs
- container registry: aws ecr
- service discovery: aws ecs + elb/alb
- log aggregation/management: docker log + cloudwatch + elasticsearch
- container hostos: coreos

* gatewayå•é¡Œç‚¹

é–‹ç™ºãŒé€²ã¿ã€APIãŒå¢—ãˆã‚‹æ¯ã«gatewayã®è‡ªä½œãŒè² æ‹…ã«...

- backendã«ãŠã‘ã‚‹å„APIã§æ›´æ–°ãŒã‚ã‚‹åº¦ã€gatewayå®Ÿè£…/deployãŒå¿…è¦
- ecs/elbã§è² è·åˆ†æ•£ã•ã‚Œã‚‹ã¨ã¯ã„ãˆã€gatewayã®å­˜åœ¨ãŒSPOFã«

ã©ã†ã™ã‚Œã°ï¼Ÿ

- APIã®è¿½åŠ ãƒ»æ›´æ–°ã¯pluggableã«è¡ŒãˆãŸã»ã†ãŒã‚ˆã•ãã†
- ã“ã®éƒ¨åˆ†ã¯buildå‰æãªgoã«å‘ã„ã¦ãªã„ï¼Ÿ

* api gateway oss

ä¸‹è¨˜ã®ã‚ˆã†ãªapi gateway toolã®å°å…¥ã‚’æ¤œè¨ä¸­

.link https://getkong.org/ kong
.image https://camo.githubusercontent.com/97aabdfeec1d04a818e3393c3bade3f54704852f/687474703a2f2f692e696d6775722e636f6d2f346a795151415a2e706e67 130 _

.link https://tyk.io/ tyk
.image https://tyk.io/wp-content/uploads/2016/03/TYK_FullLogo_WhiteText-1.png 150 _

* summary

- goã§microserviceåŒ–ã‚’é€²ã‚ãŸ
- å€‹ã€…ã®APIé–‹ç™ºã‚„containeråŒ–ã¯ã‚„ã‚Šã‚„ã™ã‹ã£ãŸ
- ä¸€æ–¹ã§api gatewayã®é–‹ç™ºã«ã¯å‘ã‹ãªã„ã‚ˆã†ã«æ„Ÿã˜ãŸ

