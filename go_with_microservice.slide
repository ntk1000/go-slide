go with microservice
container, gateway, batch
4 Oct 2016
Tags: golang,docker,immutable infrastructure, infrastructure as a code

jun asano
http://ntk1000.github.io/zlog
@ntk1000

* about me

- intelligence seeds company
- father of 2 boyz (5 and 1)

* about seeds company

- hito manager
- applicant tracking system
- b2c/b2b

* project

from 

    monolithic rails app 

to 

    "microservice" architecture


* why "microservice"?

ğŸ˜­

- å°‘ã—ã®æ©Ÿèƒ½ä¿®æ­£ã§å…¨ä½“ã‚’deployã—ç›´ã•ãªã„ã¨ã„ã‘ãªã„
- ç‰¹å®šé¡§å®¢å°‚ç”¨ã®æ©Ÿèƒ½ãŒç®¡ç†ä¸Šå…¨ä½“ã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹
- å¯†çµåˆã—ã¦ã—ã¾ã£ãŸcode

ğŸ˜Œ

- å€‹åˆ¥ã«deploy
- æœ€é©ãªæŠ€è¡“ã®é©ç”¨
- æ©Ÿèƒ½åˆ¥ã«scale up/down

* how to develop microservices

- æ©Ÿèƒ½æ¯ã«serviceã¨ã—ã¦åˆ†å‰²
- (é¡§å®¢æ•° x æ©Ÿèƒ½)æ•°ã¶ã‚“serviceã‚’ç«‹ã¡ä¸Šã’ã‚‹å¿…è¦
- containerğŸ³åŒ–ã—ã¦resourceç¯€ç´„

* why golang?

.image ./img/go_langtree.png 350 _
- 1ã¤ã®binaryã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹portablity
- Dockerfileä¸Šã§ã¯buildã—ãŸbinaryã‚’ADDã™ã‚‹ã ã‘
- èµ·å‹•æ—©ãimage sizeå°ã•ãã€containerã¨ç›¸æ€§è‰¯ã„å®Ÿæ„ŸğŸ’œ

* Dockerfile

    FROM gliderlabs/alpine:3.3
    RUN apk update

    ADD . /app
    WORKDIR /app

    EXPOSE 8080
    CMD ["/app/appName"]

* pattern

backends for frontends
.image ./img/bff.png 350 _

* pattern

api gateway
.image ./img/gateway.png 350 _

* framework

.link https://github.com/labstack/echo echo

* why echo?

- é€Ÿã•ã¨è»½ã•
- go-kitãªã©microserviceå‘ã‘frameworkã‚‚æ¤œè¨ã—ãŸãŒã—ã£ãã‚Šã“ãªã‹ã£ãŸ

* architecture

.image ./img/aws.png 580 1800

* architecture

- orchestration: aws ecs
- container registry: aws ecr
- service discovery: aws elb/alb
- container hostos: coreos

* api layer

- frontend: ui / ui backend
- gateway: apigateway / bff
- backend: å„æ©Ÿèƒ½æ¯ã®API

* å¤±æ•—

- ä¸‹ä½ã®APIã§æ›´æ–°ãŒã‚ã‚‹åº¦ã«gatewayå®Ÿè£…ãŒå¿…è¦
- gatewayãŒfatä¸”ã¤SPOFã«
- é–‹ç™ºãŒé€²ã‚“ã§APIãŒå¢—ãˆã‚‹æ¯ã«é™¤ã€…ã«gatewayã®å­˜åœ¨ãŒè² æ‹…ã«...

* api gateway oss

.link https://getkong.org/ kong

.link https://tyk.io/ tyk

* summary

- 

* go batch with docker
- require
- architecture
- actual
- golang library
- golang source
- golang compile
- docker code
- summary

* require - go batch with docker
- accept multiple triggers
  e-mail
  scheduler
  manual
- in case of failure, re-run
- auto scale

* architecture - go batch with docker
- on AWS EC2
- in Docker Container by AWS ECS
- AWS SQS long polling

* actual - go batch with docker
- enable to create multiple batches
- Dockernize

* batch dir - go batch with docker
  etc
    â”œ docker-compose.yml
    â”” go-build-batch.sh
  batch
    â”œ cmd
    â”‚ â”œ a
    â”‚ â”‚ â”œ internal
    â”‚ â”‚ â”” cmd.go
    â”‚ â”” b
    â”‚   â”œ internal
    â”‚   â”” cmd.go
    â”œ deploy
    â”‚   â”œ a
    â”‚   â”‚ â”” Dockerfile
    â”‚   â”” b
    â”‚     â”” Dockerfile
    â”œ internal
    â”œ root
    â”‚   â”” root.go
    â”” main.go

* golang source(1) - go batch with docker
  batch
    â”œ cmd
    â”‚ â”” a
    â”‚   â”” cmd.go
    â”œ root
    â”‚   â”” root.go
    â”” *main.go*

* golang source(1) - go batch with docker
- batch/main.go
.code source/main.go /^func main/,/^}/

* golang source(2) - go batch with docker
  batch
    â”œ cmd
    â”‚ â”” a
    â”‚   â”” cmd.go
    â”œ root
    â”‚   â”” *root.go*
    â”” main.go

* golang source(2) - go batch with docker
- batch/root/root.go
.code source/root.go

* golang source(3) - go batch with docker
  batch
    â”œ cmd
    â”‚ â”” a
    â”‚   â”” *cmd.go*
    â”œ root
    â”‚   â”” root.go
    â”” main.go

* golang source(3) - go batch with docker
- batch/cmd/a/cmd.go
.code source/cmd.go /^import/,/^}/

* golang compile - go batch with docker
  etc
    â”œ docker-compose.yml
    â”” *go-build-batch.sh*
  batch
    â”” deploy
        â”œ a
        â”‚ â”” Dockerfile
        â”” b
          â”” Dockerfile

* compile - go batch with docker
- etc/go-build-batch.sh
.code source/go-build-batch.sh
'batch/main.go' is compiled,  a binary file is copied to each folders under 'deploy'.

* docker code(1) - go batch with docker
  etc
    â”œ docker-compose.yml
    â”” go-build-batch.sh
  batch
    â”” deploy
        â”œ a
        â”‚ â”œ *Dockerfile*
        â”‚ â”” xxxmicro
        â”” b
          â”œ Dockerfile
          â”” xxxmicro

* docker code(1) - go batch with docker
- batch/deply/a/Dockerfile
.code source/Dockerfile

* docker code(2) - go batch with docker
  etc
    â”œ *docker-compose.yml*
    â”” go-build-batch.sh
  batch
    â”” deploy
        â”œ a
        â”‚ â”œ Dockerfile
        â”‚ â”” xxxmicro
        â”” b
          â”œ Dockerfile
          â”” xxxmicro

* docker code(2) - go batch with docker
- etc/docker-compose.yml
.code source/docker-compose.yml

* summary - go batch with docker
- only one 'func main'
- subcommand-based CLIs. such as 'spf13/cobra'
- infinite loop for a docker process and AWS SQS polling
