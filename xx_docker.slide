docker pattern
30 Jun 2016
Tags: golang,docker,docker-compose,coreos,aws,ecs,ecr

jun asano
http://ntk1000.github.io/zlog
@ntk1000

* agenda
- current status
- local dev
- aws stg/prod
- todo

* current status
- using docker from local dev to stg/prod env
- docker-compose on local dev
- aws ecs/ecr on stg/prod env
- å…¨ã¦ãŒã‚³ãƒ³ãƒ†ãƒŠã«ãªã‚‹

* components
- nginx
- nodejs app for frontend
- golang app for backend api
- mackerel-agent (with entrykit)
- aws-auth-proxy

* components local only
- redis -> Elasticache
- mysql -> RDS
- elastic search -> Elasticsearch
- dynamodb local -> Dynamodb
- datastoreç³»ã¯dbaasã«ä»»ã›ã‚‹
- dockerã§é ‘å¼µã‚‰ãªã„

* local dev
.image ./img/x.png 600 _

* local dev host
- docker toolbox aka boot2docker
- docker for macã¯è©¦ã—ã¦ãªã„ é–‹ç™ºè½ã¡ç€ã„ãŸã‚‰åˆ‡ã‚Šæ›¿ãˆãŸã„

* local dev docker orchestration
- docker-compose
- docker link

* nodejs
- docker buildé…ã„å•é¡Œ
- npm installæ¸ˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨app addåŠã³èµ·å‹•ã®ã¿ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«åˆ†ã‘ãŸæ–¹ãŒã‚ˆã•ãã†

* golang
- go buildã—ãŸãƒã‚¤ãƒŠãƒªã‚’addã—ã¦èµ·å‹•ã™ã‚‹ã ã‘
- go buildé…ã„å•é¡Œã¯ã‚ã‚‹

* middleware
- confã§è¨­å®šã™ã‚‹ç³»(fluentd,nginxãªã©) å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã«conf addã—ãŸã‚‚ã®ã§ã‚¤ãƒ¡ãƒ¼ã‚¸åŒ–
- confã§è¨­å®šä¸”ã¤ä¸­èº«ã‚’å‹•çš„ã«å¤‰ãˆãŸã„ç³»(mackerel-agent,nginxãªã©) entrykitã‚’addã—ã¦entrykitçµŒç”±ã§ã„ã˜ã‚‹

* environment variables
- 12 factor appã®æ•™ãˆ
- ç’°å¢ƒã§å¤‰å‹•ã™ã‚‹ã‚‚ã®ã€ã‚½ãƒ¼ã‚¹ç®¡ç†ã•ã›ãªã„ã‚‚ã®ã¯ç’°å¢ƒå¤‰æ•°ã«å°ã˜è¾¼ã‚ã‚‹
- ã‚­ãƒ¼æƒ…å ±ãªã©ã¯confluenceç®¡ç†

* microservice
- apiãŸãã•ã‚“ã‚ã‚‹ ãã‚Œãã‚Œvmç«‹ã¦ã‚‹ã®ã¯ç¾å®Ÿçš„ã§ãªã„
- è‡ªåˆ†ãŒé–‹ç™ºã™ã‚‹éƒ¨åˆ†ä»¥å¤–ã®apiã¯docker-composeã§ç«‹ã¦ã¦ãŠã„ã¦é€£æºç¢ºèª
- datastore(mysql, elastic search, dynamodb)ã‚‚ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ã€é–‹ç™ºè€…é–“ã§åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹

* docker-compose
- è‰¯ã„
- ã‚³ãƒ³ãƒ†ãƒŠé–“ä¾å­˜é–¢ä¿‚ã®å¯è¦–åŒ–ã€ã©ã“ã‚’ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã™ã¹ãã‹ã€yamlã§æŠŠæ¡ã—ã‚„ã™ã„
- ä¸€éƒ¨dockerã‚³ãƒãƒ³ãƒ‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã«ãªã£ã¦ãŠã‚Šã€æ“ä½œãŒæ¥½(dockerã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¤šã™ãã¦è¦šãˆã‚‰ã‚Œãªã„ğŸ˜­)

* aws stg/prod
.image ./img/x.png 600 _

* aws ecr
- private docker repository
- full managed
- 12æ™‚é–“ã§èªè¨¼åˆ‡ã‚Œã‚‹ã®ã§docker pull/pushã™ã‚‹éš›ã¯å†èªè¨¼ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹
- tokyo regionå¯¾å¿œã¯ã‚ˆ

* multi hosting
- stg/prodã§ã¯å½¹å‰²æ¯ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆå¤‰ãˆã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é«˜ã‚ãŸã„
- frontend, backend api, datastoreã®3æ§‹æˆ
- docker linkã§ã¯è§£æ±ºã§ããªã„ã€ã„ã‚ã‚†ã‚‹service discoveryãŒå¿…è¦

* service discovery
- ã„ãã¤ã‹è©¦ã—ãŸ
- ambassador
- etcd, skydns, registrator
- kubernetes
- æ§‹æˆã®ç…©é›‘ã•ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€awsã®å¯¾å¿œçŠ¶æ³ãªã©ã‚’ç†ç”±ã«æ¡ç”¨æ–­å¿µ
- weaveã¯è©¦ã—ã¦ãªã„
- kubernetesã®ä»Šå¾Œã«æœŸå¾…

* aws ecs

* todo
- docker security (https://docs.docker.com/engine/security/security/)
