docker pattern
30 Jun 2016
Tags: golang,docker,docker-compose,coreos,aws,ecs,ecr

jun asano
http://ntk1000.github.io/zlog
@ntk1000

* agenda
- components
- local dev
- aws stg/prod
- todo

* summary
- using docker from local dev to stg/prod
- docker-compose on local dev
- aws ecs/ecr on stg/prod
- å…¨éƒ¨ã‚³ãƒ³ãƒ†ãƒŠã§ç®¡ç†

* components
- nginx
- nodejs app for frontend
- golang app for backend api
- mackerel-agent (with entrykit)
- aws-auth-proxy

* components local only
- å…¨éƒ¨ã‚³ãƒ³ãƒ†ãƒŠã§ã¨è¨€ã£ãŸã‘ã©...
- datastoreç³»ã¯dbaasã«ä»»ã›ã‚‹
- redis -> Elasticache
- mysql -> RDS
- elastic search -> Elasticsearch
- dynamodb local -> Dynamodb
- dockerã§é ‘å¼µã‚‰ãªã„(é‹ç”¨è¾›ãã†)

* local dev
.image ./img/localdev.png 550 _

* local dev host
- docker toolbox aka boot2docker vm
- docker for macã¯è©¦ã—ã¦ãªã„
- é–‹ç™ºè½ã¡ç€ã„ãŸã‚‰åˆ‡ã‚Šæ›¿ãˆãŸã„

* docker os
- alpine linux
- docker push/pullé »ç¹ã«è¡Œã†ã®ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºå°ã•ã„ã“ã¨ãŒé‡è¦
- dockerå…¬å¼ã‚‚alpineæ¡ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸å¢—ãˆãŸ

* local dev docker orchestration
- docker-compose
- docker link

* docker-compose.yaml
	nginx:
	  build: ../toolbox/nginx
	  environment:
	    - TZ=JST-9
	  ports:
	    - "80:80"
	  links:
	    - ui
	
	ui:
	  build: ../ui
	  environment:
	    - NODE_PORT=3000
	    - NODE_WS_PORT=8080
	    - NODE_ENV=production
	  ports:
	    - "3000:3000"
	    - "443:8080"
	  links:
	    - redis_front
	
	redis_front:
	  image: redis:alpine
	  environment:
	    - TZ=JST-9


* nodejs
- docker buildé…ã„å•é¡Œ
- npm installæ¸ˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨app addåŠã³èµ·å‹•ã®ã¿ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«åˆ†ã‘ãŸæ–¹ãŒã‚ˆã•ãã†

* golang
- go buildã—ãŸãƒã‚¤ãƒŠãƒªã‚’addã—ã¦èµ·å‹•ã™ã‚‹ã ã‘
- go buildé…ã„å•é¡Œã¯ã‚ã‚‹(go buildã‚ˆã‚Šgo installã®ãŒæ—©ã„ã‚‰ã—ã„ï¼Ÿ)

* middleware
- confã§è¨­å®šã™ã‚‹ç³»(fluentd,nginxãªã©)
- å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã«è‡ªå‰ã®confã‚’è¿½åŠ ã—ãŸã‚‚ã®ã§ã‚¤ãƒ¡ãƒ¼ã‚¸åŒ–
- confã§è¨­å®šä¸”ã¤ä¸­èº«ã‚’å‹•çš„ã«å¤‰ãˆãŸã„ç³»(mackerel-agent,nginxãªã©)
- entrykitã‚’addã—ã¦entrykitçµŒç”±ã§ã„ã˜ã‚‹(ç’°å¢ƒå¤‰æ•°ã§å¤‰æ›´ã§ãã‚‹)
.link https://github.com/progrium/entrykit entrykit

* environment variables
- 12 factor appã®æ•™ãˆ
- ç’°å¢ƒã§å¤‰å‹•ã™ã‚‹ã‚‚ã®ã€ã‚½ãƒ¼ã‚¹ç®¡ç†ã•ã›ãªã„ã‚‚ã®ã¯ç’°å¢ƒå¤‰æ•°ã«å°ã˜è¾¼ã‚ã‚‹
- ã‚­ãƒ¼æƒ…å ±ãªã©ã¯confluenceç®¡ç†
.link http://12factor.net/ja/ 12factorapp

* microservice
- apiãŸãã•ã‚“ã‚ã‚‹
- ãã‚Œãã‚Œvmç«‹ã¦ã‚‹ã®ã¯ç¾å®Ÿçš„ã§ãªã„
- ã‚³ãƒ³ãƒ†ãƒŠã¨ã®è¦ªå’Œæ€§ã¯é«˜ã„
- è‡ªåˆ†ãŒé–‹ç™ºã™ã‚‹éƒ¨åˆ†ä»¥å¤–ã®apiã¯docker-composeã§ç«‹ã¦ã¦ãŠã‘ã°ã‚ã–ã‚ã–ãƒ¢ãƒƒã‚¯ã‚’ä½œã‚‰ãªãã¦è‰¯ã„
- é–‹ç™ºæ™‚ã¯datastore(mysql, elastic search, dynamodb)ã‚‚ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ã€é–‹ç™ºè€…é–“ã§åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹

* docker-compose
- ç·ã˜ã¦è‰¯ã„
- v2ã¾ã è©¦ã—ã¦ãªã„
- ã‚³ãƒ³ãƒ†ãƒŠé–“ä¾å­˜é–¢ä¿‚ã®å¯è¦–åŒ–ã€ã©ã“ã‚’ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã™ã¹ãã‹ã€yamlãªã®ã§æŠŠæ¡ã—ã‚„ã™ã„
- ä¸€éƒ¨dockerã‚³ãƒãƒ³ãƒ‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã«ãªã£ã¦ãŠã‚Šã€æ“ä½œãŒæ¥½
- (dockerå˜ä½“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¤šã™ãã¦è¦šãˆã‚‰ã‚Œãªã„ğŸ˜­)

* aws stg/prod
.image ./img/aws.png 550 _

* aws ecr
- private container registry
- full managed
- 12æ™‚é–“ã§èªè¨¼åˆ‡ã‚Œã‚‹ã®ã§docker pull/pushã™ã‚‹éš›ã¯å†èªè¨¼ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹
- tokyo regionå¯¾å¿œæœ›ã¾ã‚Œã‚‹

* multi hosting
- stg/prodã§ã¯å½¹å‰²æ¯ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆå¤‰ãˆã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é«˜ã‚ãŸã„
- frontend, backend api, datastoreã®3æ§‹æˆãŒæœ€ä½é™å¿…è¦
- hostè·¨ã„ã å ´åˆã€docker linkã§ã¯è§£æ±ºã§ããªã„ã€ã„ã‚ã‚†ã‚‹service discoveryãŒå¿…è¦

* service discovery
- ã„ãã¤ã‹è©¦ã—ãŸ
- ambassador
- etcd, skydns, registrator
- kubernetes
- æ§‹æˆã®ç…©é›‘ã•ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€awsã®å¯¾å¿œçŠ¶æ³ãªã©ã‚’ç†ç”±ã«æ¡ç”¨æ–­å¿µğŸ˜£
- weave, docker networkingã¯è©¦ã—ã¦ãªã„
- kubernetesã®ä»Šå¾Œã«æœŸå¾…ğŸ˜‡

* aws ecs
- ã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆã‚’task definitionã€ã©ã®ã‚¯ãƒ©ã‚¹ã‚¿ã§taskã‚’å‹•ã‹ã™ã‹ã‚’serviceã¨ã„ã†æ¦‚å¿µã§å®šç¾©
- task definitionã¯å¤§å‡¡docker-composeã§å®šç¾©ã—ã¦ã„ãŸå†…å®¹ã‚’jsonã«ç›´ã—ãŸã‚‚ã®
- ecrã¨ã¯åˆ¥ã«taskå˜ä½ã§revisionç®¡ç†ã•ã‚Œã‚‹
- serviceã¯ã‚¯ãƒ©ã‚¹ã‚¿(ec2 autoscale)ã¨elbã€å‹•ã‹ã™ã‚³ãƒ³ãƒ†ãƒŠæ•°ã‚’å®šç¾©
- service discoveryã§å•é¡Œã ã£ãŸã€ã©ã“ã§ã‚³ãƒ³ãƒ†ãƒŠãŒå‹•ã„ã¦ã„ã‚‹ã‹ã€ãŒelbã«é™å®šã•ã‚Œã‚‹ã®ã§ç®¡ç†ãŒæ¥½
- (1elbã§portæ¯ã®å®šç¾©ãŒã§ãã‚Œã°ã‚‚ã£ã¨ä¾¿åˆ©ã«ãªã‚‹)
- ã‚³ãƒ³ãƒ†ãƒŠãŒè½ã¡ã¦ã‚‚å¸Œæœ›ã™ã‚‹ç¨¼åƒã‚³ãƒ³ãƒ†ãƒŠæ•°ã«é”ã™ã‚‹ã¾ã§è‡ªå‹•çš„ã«èµ·å‹•ã—ã¦ãã‚Œã‚‹

* blue green deployment
- ä¸€ç•ªå¬‰ã—ã„æ©Ÿèƒ½â˜ºï¸
- service updateã—ãŸæ™‚ã«elbã‹ã‚‰æ¥ç¶šå…ˆã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ‡æ›¿ã‚’ã‚ˆã—ãªã«ã‚„ã£ã¦ãã‚Œã‚‹
- taskãŒrevisionç®¡ç†ã•ã‚Œã¦ã‚‹ã®ã§å•é¡ŒãŒã‚ã£ãŸå ´åˆã®åˆ‡ã‚Šæˆ»ã—ã‚‚ã»ã¼åŒã˜æ‰‹é †ã§ã§ãã‚‹(å‰ã®revisionæŒ‡å®šã—ã€service update)
- taskãŒæŒ‡ã™ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚å³å¯†ã«åŒºåˆ¥ãŒã¤ãã‚ˆã†ã€git commit hashã‚’ã‚¿ã‚°ä»˜ã‘ã™ã‚‹ã‚ˆã†ã«ã—ãŸ

* step1
.image https://blog.codeship.com/wp-content/uploads/2015/09/Tasks-split-between-two-EC2-instances.jpg 550 _

* step2
.image https://blog.codeship.com/wp-content/uploads/2015/09/ECS-launches-a-new-task.jpg 550 _

* step3
.image https://blog.codeship.com/wp-content/uploads/2015/09/ECS-killing-tasks-and-launching-new-ones.jpg 550 _

* step4
.image https://blog.codeship.com/wp-content/uploads/2015/09/ECS-has-met-the-desired-tasks.jpg 550 _

* stg/prod host
- ecs(amazon linuxè»½é‡åŒ–ã—ã¦dockerã¨ecs-agentè¼‰ã›ãŸã‚‚ã®)ã¨ coreosã‚’ä½µç”¨
- æœ¬å½“ã¯coreosã«ã¾ã¨ã‚ãŸã„ãŒã€cloudwatchlogså‹•ã‹ãªã‹ã£ãŸã‚Šä¸å®‰å®šãªã®ã§ã¾ã æ§˜å­è¦‹

* todo
- docker securityã‚’é«˜ã‚ã‚‹(https://docs.docker.com/engine/security/security/)

* ã¾ã¨ã‚
.image ./img/containeraddicted.png 550 _
